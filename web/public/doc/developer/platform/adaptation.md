# 平台适配开发指南

> 本文档旨在帮助开发者基于现有项目进行多平台应用开发，包括原生应用（非 WebView）、小程序等。

## 当前项目实现方案（参考）

项目目前采用**响应式 Web 设计 + WebView 封装**的跨平台方案：

- **Web 端**：通过屏幕宽度（`window.innerWidth <= 1000px`）判断设备类型，使用 `AppMobile.vue` 和 `AppDesktop.vue` 分离移动端和桌面端
- **Android 应用**：使用 WebView 加载网页（`android/` 目录）
- **HarmonyOS 应用**：使用 Web 组件加载网页（`harmony/` 目录）

> **注意**：这些 WebView 应用仅作为参考实现。如需开发原生应用（非 WebView），请参考下文指引。

---

## 开发前必读

### 1. 后端 API 文档

**后端项目仓库**：[https://github.com/zzysssigm/SHARE_SDU](https://github.com/zzysssigm/SHARE_SDU)

**重要提示**：
- 项目根目录的 `api.md` 文件可能不是最新版本
- **必须联系管理员获取最新的 API 文档**
- 后端项目仍在开发中，API 可能有更新

### 2. 数据格式转换

**位置**：`web/src/api/modules/api_convert/`

前后端命名规范不一致，需要实现格式转换：
- 后端使用下划线命名（如 `user_id`、`article_title`）
- 前端使用驼峰命名（如 `userId`、`articleTitle`）
- 参考 `api_convert` 目录中的转换函数实现

### 3. 帖子内容构建与解析（重要）

**位置**：`web/src/components/post/README.md`、`web/src/utils/post.js`、`web/src/components/common/WithLinkContainer.vue`

#### 帖子内容格式

1. **关联项目标识**
   - 如果帖子内容以 `#/` 开头，表示该帖子关联到某个项目（文章或课程）
   - 格式：`#/{type}/{id}\n{实际内容}`
   - 例如：`#/article/123\n这是帖子内容`

2. **图片处理**
   - 图片链接使用方括号包裹：`[图片URL]`
   - 这些图片会被提取出来，显示在帖子内容下方
   - 在显示时，方括号包裹的图片链接会被移除，只显示文本内容

3. **HTML 帖子**
   - 如果内容以 `SELF-DEFINE-HTML` 开头，表示这是一个 HTML 帖子
   - HTML 帖子会直接在 iframe 中渲染，不进行文本解析
   - HTML 帖子设计建议：
     - 自定义样式、函数等统一添加用户名作为前缀，避免冲突
     - 避免使用攻击性代码
     - PC 端最佳宽度 700px，移动端最佳宽度 98vw
     - 样式过宽会采用滚动条，过窄会自动居中

4. **链接识别**
   - 自动识别内容中的链接并渲染为可点击的链接

5. **回复格式**
   - 回复内容有特殊格式：`@{作者名}\n{父回复ID}\n{实际内容}`
   - 在显示时需要解析这个格式，提取作者名、父回复ID和实际内容

#### 帖子提交逻辑

**位置**：`web/src/components/post/PostEditor.vue`

1. **图片上传**
   - 先上传所有图片，获取图片 URL
   - 图片需要压缩（最大 4MB）
   - 将图片 URL 以 `[图片URL]` 格式追加到内容末尾

2. **添加关联链接**
   - 如果帖子关联到文章或课程，使用 `addLinkToPost()` 函数在内容开头添加 `#/{type}/{id}\n`

3. **提交数据**
   - 标题和内容都有最小长度限制（2个字符）
   - 根据帖子类型调用不同的 API（文章下的帖子、课程下的帖子、普通帖子）

### 4. 文章内容构建与解析（重要）

**位置**：`web/src/utils/common.js`、`web/src/utils/editor.js`、`web/src/components/article/ArticleDisplay.vue`

#### 文章内容格式

1. **编辑器类型标识**
   - 文章内容开头有编辑器类型标识：`html` 或 `md`
   - `html` 表示 HTML 编辑器，`md` 表示 Markdown 编辑器
   - 在存储时，编辑器类型标识会作为内容的前缀

2. **内容解析**
   - 获取文章时，需要先提取编辑器类型（前2-4个字符）
   - 然后移除编辑器类型标识，获取实际内容
   - 根据编辑器类型选择对应的渲染组件（HTML 编辑器或 Markdown 预览）

3. **图片处理**
   - 文章中的图片链接格式：`{apiBaseUrl}/image/get/{图片名}`
   - 需要调用图片获取接口进行格式化处理
   - 图片可能有不同的状态（审核中、未通过等），需要处理相应的占位图

4. **文章数据结构**
   - 文章包含多个字段：标题、摘要、类型、标签、封面链接、原始链接、资源链接等
   - 需要从后端响应中提取并转换为前端格式

#### 文章提交逻辑

**位置**：`web/src/api/modules/api_convert/article.js`

1. **编辑器类型处理**
   - 创建文章时，需要将编辑器类型（`html` 或 `md`）作为内容前缀
   - 使用 `setDictString('editor', data.editor)` 生成类型标识

2. **数据格式转换**
   - 前端数据（驼峰命名）转换为后端数据（下划线命名）
   - 例如：`title` → `article_title`，`originLink` → `origin_link`

### 5. 获取帮助

如遇到问题，可以通过以下方式获取帮助：

1. **联系管理员**
   - 获取项目访问权限
   - 咨询技术问题
   - 申请 API 测试账号

2. **查看源代码**
   - **前端代码**：`web/src/` 目录（公开可访问）
     - `web/src/api/modules/` - API 调用逻辑
     - `web/src/api/modules/api_convert/` - 数据格式转换
     - `web/src/components/` - 组件实现（包含业务逻辑）
     - `web/src/utils/` - 工具函数
   - **后端代码**：
     - 后端项目仓库：[https://github.com/zzysssigm/SHARE_SDU](https://github.com/zzysssigm/SHARE_SDU)
     - 需要联系管理员获取完整访问权限和最新 API 文档

---

## 原生应用开发（非 WebView）

### 核心注意事项

#### 1. 帖子内容解析（必须正确实现）

**解析规则**：
- 检查内容是否以 `#/` 开头，提取关联项目信息（格式：`#/{type}/{id}\n{内容}`）
- 提取 `[图片URL]` 格式的图片链接，这些图片需要单独显示在内容下方
- 在显示文本内容时，需要移除 `[图片URL]` 格式的图片链接
- 检查是否以 `SELF-DEFINE-HTML` 开头，判断是否为 HTML 帖子
- HTML 帖子需要在 iframe 中渲染，注意安全限制
- 识别并渲染内容中的链接
- 对于回复，解析 `@{作者名}\n{父回复ID}\n{内容}` 格式

**提交规则**：
- 先上传所有图片（需要压缩，最大 4MB）
- 将图片 URL 以 `[图片URL]` 格式追加到内容末尾
- 如果帖子关联文章/课程，在内容开头添加 `#/{type}/{id}\n`
- 验证标题和内容长度（最小 2 个字符）

#### 2. 文章内容解析（必须正确实现）

**解析规则**：
- 提取编辑器类型（内容前 2-4 个字符：`html` 或 `md`）
- 移除类型标识，获取实际内容
- 根据类型选择渲染方式（HTML 编辑器或 Markdown 预览）
- 处理图片链接（格式：`{apiBaseUrl}/image/get/{图片名}`）
- 图片可能有不同状态（审核中、未通过等），需要处理相应的占位图

**提交规则**：
- 将编辑器类型作为内容前缀（`html` 或 `md`）
- 进行数据格式转换（驼峰 → 下划线）

#### 3. 数据格式转换

必须实现前后端数据格式转换（下划线 ↔ 驼峰），参考 `web/src/api/modules/api_convert/` 目录。

---

## 小程序开发

小程序开发同样需要实现上述的**帖子解析、文章解析、数据格式转换**等功能。

### 核心注意事项

1. **帖子内容解析**：必须正确实现关联项目提取、图片提取、HTML 帖子识别等
2. **文章编辑器类型**：必须处理编辑器类型标识（`html`/`md`）
3. **数据格式转换**：必须实现前后端数据格式转换
4. **图片处理**：图片上传、压缩、状态处理

---

## 开发资源

### 必须查看的资源

1. **后端 API 文档**
   - 后端项目仓库：[https://github.com/zzysssigm/SHARE_SDU](https://github.com/zzysssigm/SHARE_SDU)
   - **重要**：必须联系管理员获取最新的 API 文档

2. **帖子解析逻辑**
   - `web/src/components/post/README.md` - 帖子解析规则
   - `web/src/utils/post.js` - 帖子工具函数
   - `web/src/components/common/WithLinkContainer.vue` - 帖子内容渲染

3. **文章解析逻辑**
   - `web/src/utils/common.js` - `responseToArticle` 函数
   - `web/src/utils/editor.js` - 编辑器类型处理
   - `web/src/components/article/ArticleDisplay.vue` - 文章渲染

4. **数据格式转换**
   - `web/src/api/modules/api_convert/` - 前后端数据格式映射

### 获取帮助

- **联系管理员**：获取最新 API 文档、项目访问权限、测试账号等
- **查看源代码**：前端代码在 `web/src/` 目录（公开），后端代码需要联系管理员

---

## 关键注意事项总结

### 帖子内容格式

1. **关联项目标识**：`#/{type}/{id}\n{内容}`
2. **图片格式**：`[图片URL]`（会被提取显示在下方，文本中需移除）
3. **HTML 帖子**：`SELF-DEFINE-HTML{HTML内容}`（需在 iframe 中渲染）
4. **回复格式**：`@{作者名}\n{父回复ID}\n{内容}`

### 文章内容格式

1. **编辑器类型**：内容前缀 `html` 或 `md`（前 2-4 个字符）
2. **图片链接**：需要调用图片获取接口处理，可能有不同状态

### 其他

1. **数据格式转换**：必须实现前后端格式转换（下划线 ↔ 驼峰）
2. **图片处理**：上传前压缩（最大 4MB），处理图片状态

---

## 注意事项

1. **帖子内容解析是核心**：必须正确解析关联项目、图片提取、HTML 帖子识别等
2. **文章编辑器类型**：必须处理 `html`/`md` 类型标识
3. **数据格式转换**：前后端命名不一致，必须实现转换层
4. **图片处理**：上传压缩、状态处理都需要实现
5. **HTML 帖子安全**：在 iframe 中渲染，注意安全限制

---

## 总结

开发多平台应用的关键是：

1. **理解内容格式**：仔细阅读帖子 and 文章的内容格式规则
2. **实现数据转换**：参考 `api_convert` 目录实现格式转换
3. **正确解析内容**：按照项目规则解析帖子和文章内容
4. **获取帮助**：遇到问题及时联系管理员或查看源代码

祝您开发顺利！如有问题，欢迎联系管理员。